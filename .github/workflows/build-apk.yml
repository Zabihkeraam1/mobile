name: Build Android APK -> S3 (Presigned URL)

on:
  workflow_dispatch:
    inputs:
      expires_in:
        description: "Presigned URL expiry in seconds (max 604800 = 7 days)"
        required: false
        default: "604800"

jobs:
  android_apk:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install dependencies
        run: npm ci
        
      - name: Expo dependency check
        run: npx expo install --check

      # Generates android/ (since your repo is managed Expo)
      - name: Expo prebuild (Android)
        run: CI=1 npx expo prebuild --platform android --clean --skip-dependency-update expo,react-native,react --no-install

      # Put the keystore where we'll reference it from credentials.json
      - name: Decode keystore
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p android/app
          printf '%s' "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
          test -s android/app/upload-keystore.jks
      - name: Write signing props (android/gradle.properties)
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "MYAPP_UPLOAD_STORE_FILE=upload-keystore.jks"
            echo "MYAPP_UPLOAD_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}"
            echo "MYAPP_UPLOAD_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}"
            echo "MYAPP_UPLOAD_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}"
          } >> android/gradle.properties

      - name: Create android/app/signing.gradle
        shell: bash
        run: |
          set -euo pipefail
          cat > android/app/signing.gradle <<'EOF'
          android {
            signingConfigs {
              release {
                if (project.hasProperty("MYAPP_UPLOAD_STORE_FILE")) {
                  storeFile file(MYAPP_UPLOAD_STORE_FILE)
                  storePassword MYAPP_UPLOAD_STORE_PASSWORD
                  keyAlias MYAPP_UPLOAD_KEY_ALIAS
                  keyPassword MYAPP_UPLOAD_KEY_PASSWORD
                }
              }
            }

            buildTypes {
              release {
                signingConfig signingConfigs.release
              }
              debug {
                signingConfig signingConfigs.release
              }
            }
          }
          EOF

      - name: Ensure app/build.gradle applies signing.gradle
        shell: bash
        run: |
          set -euo pipefail
          FILE="android/app/build.gradle"
          if ! grep -q 'apply from: "./signing.gradle"' "$FILE"; then
            echo '' >> "$FILE"
            echo 'apply from: "./signing.gradle"' >> "$FILE"
          fi

      # Build a directly-installable APK
      - name: Build signed APK (Release)
        shell: bash
        run: |
          set -euo pipefail
          cd android
          ./gradlew --no-daemon :app:assembleRelease

      - name: Locate APK
        id: out
        shell: bash
        run: |
          set -euo pipefail
          APK_PATH="$(ls -1 android/app/build/outputs/apk/release/*release*.apk | head -n 1)"
          echo "apk=$APK_PATH" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      - name: Upload to private S3 + presign URL
        shell: bash
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          set -euo pipefail

          KEY="mobile-builds/${{ github.repository }}/${{ github.run_id }}/app-release.apk"
          aws s3 cp "${{ steps.out.outputs.apk }}" "s3://${S3_BUCKET}/${KEY}" \
            --content-type "application/vnd.android.package-archive"

          EXPIRES="${{ inputs.expires_in }}"
          if [ "$EXPIRES" -gt 604800 ]; then EXPIRES=604800; fi  # AWS CLI max 7 days

          URL="$(aws s3 presign "s3://${S3_BUCKET}/${KEY}" --expires-in "${EXPIRES}")"

          echo "âœ… S3 Object: s3://${S3_BUCKET}/${KEY}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Presigned download URL:" >> $GITHUB_STEP_SUMMARY
          echo "${URL}" >> $GITHUB_STEP_SUMMARY
